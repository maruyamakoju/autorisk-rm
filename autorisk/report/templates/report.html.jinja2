<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ title }}</title>
<style>
  :root {
    --nvidia: #76b900;
    --nvidia-dark: #1a1a2e;
    --high: #dc3545;
    --medium: #fd7e14;
    --low: #ffc107;
    --none: #28a745;
    --bg: #f8f9fa;
    --card-bg: #ffffff;
    --text: #212529;
    --border: #dee2e6;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
  }

  /* Hero Banner */
  .hero {
    background: linear-gradient(135deg, var(--nvidia-dark) 0%, #16213e 100%);
    color: white;
    padding: 2.5rem 2rem;
    margin-bottom: 2rem;
  }
  .hero-inner {
    max-width: 1200px;
    margin: 0 auto;
  }
  .hero h1 {
    font-size: 2rem;
    margin-bottom: 0.3rem;
  }
  .hero .subtitle {
    color: var(--nvidia);
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  .hero .meta {
    color: #a0aec0;
    font-size: 0.9rem;
  }

  /* Pipeline Diagram */
  .pipeline-section {
    max-width: 1200px;
    margin: 0 auto 2rem;
    padding: 0 2rem;
  }
  .pipeline {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0;
    padding: 1.5rem;
    background: var(--card-bg);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow-x: auto;
  }
  .pipeline-step {
    text-align: center;
    padding: 1rem 1.2rem;
    border-radius: 8px;
    min-width: 140px;
    position: relative;
  }
  .pipeline-step.mining {
    background: #e3f2fd;
    border: 2px solid #1976d2;
  }
  .pipeline-step.cosmos {
    background: #e8f5e9;
    border: 2px solid var(--nvidia);
  }
  .pipeline-step.eval {
    background: #fff3e0;
    border: 2px solid #f57c00;
  }
  .pipeline-step .step-label {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.3rem;
  }
  .pipeline-step.mining .step-label { color: #1976d2; }
  .pipeline-step.cosmos .step-label { color: #2e7d32; }
  .pipeline-step.eval .step-label { color: #f57c00; }
  .pipeline-step .step-title {
    font-weight: 600;
    font-size: 0.85rem;
    margin-bottom: 0.2rem;
  }
  .pipeline-step .step-detail {
    font-size: 0.72rem;
    color: #6c757d;
  }
  .pipeline-arrow {
    font-size: 1.5rem;
    color: #adb5bd;
    padding: 0 0.3rem;
    flex-shrink: 0;
  }

  /* Main content */
  .content {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem 2rem;
  }
  h2 { font-size: 1.4rem; margin: 2rem 0 1rem; border-bottom: 2px solid var(--border); padding-bottom: 0.5rem; }
  h3 { font-size: 1.1rem; margin-bottom: 0.5rem; }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }
  .summary-card {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    border-left: 4px solid;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .summary-card.high { border-color: var(--high); }
  .summary-card.medium { border-color: var(--medium); }
  .summary-card.low { border-color: var(--low); }
  .summary-card.none { border-color: var(--none); }
  .summary-card .count { font-size: 2rem; font-weight: 700; }
  .summary-card .label { font-size: 0.85rem; color: #6c757d; text-transform: uppercase; }

  /* Clip cards */
  .card {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border-left: 4px solid var(--border);
  }
  .card.high { border-left-color: var(--high); }
  .card.medium { border-left-color: var(--medium); }
  .card.low { border-left-color: var(--low); }
  .card.none { border-left-color: var(--none); }
  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.8rem;
  }
  .cosmos-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    background: var(--nvidia-dark);
    color: var(--nvidia);
    padding: 0.15rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
  }
  .cosmos-tag::before {
    content: "\25C6";
    font-size: 0.6rem;
  }
  .badge {
    display: inline-block;
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
    color: white;
  }
  .badge.high { background: var(--high); }
  .badge.medium { background: var(--medium); }
  .badge.low { background: var(--low); }
  .badge.none { background: var(--none); }
  .detail { margin: 0.5rem 0; }
  .detail-label { font-weight: 600; color: #495057; }
  .hazard-list { list-style: none; padding-left: 1rem; }
  .hazard-list li { margin: 0.3rem 0; }
  .evidence-list { list-style: disc; padding-left: 1.5rem; }

  /* Cosmos output fields */
  .cosmos-output {
    background: #f0faf0;
    border: 1px solid #c8e6c9;
    border-radius: 6px;
    padding: 0.8rem 1rem;
    margin-top: 0.8rem;
  }
  .cosmos-output-label {
    font-size: 0.72rem;
    font-weight: 700;
    color: #2e7d32;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.4rem;
  }

  /* Metrics */
  table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
    background: var(--card-bg);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border); }
  th { background: #e9ecef; font-weight: 600; }
  tr:last-child td { border-bottom: none; }
  .metric-value { font-size: 1.5rem; font-weight: 700; }
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
  }
  .metric-card {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  /* Ablation visual comparison */
  .ablation-compare {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin: 1.5rem 0;
  }
  .ablation-card {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .ablation-card.baseline {
    border-top: 3px solid #adb5bd;
  }
  .ablation-card.cosmos {
    border-top: 3px solid var(--nvidia);
  }
  .ablation-card h4 {
    font-size: 0.9rem;
    margin-bottom: 1rem;
  }
  .ablation-card .ab-metric {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.4rem 0;
    border-bottom: 1px solid #f0f0f0;
  }
  .ablation-card .ab-metric:last-child { border-bottom: none; }
  .ab-bar-wrap {
    width: 60%;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
  }
  .ab-bar {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s;
  }
  .baseline .ab-bar { background: #adb5bd; }
  .cosmos .ab-bar { background: var(--nvidia); }

  /* Timeline */
  .timeline-wrap {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  .timeline-bar {
    position: relative;
    height: 32px;
    background: #e9ecef;
    border-radius: 6px;
    margin-top: 0.5rem;
    overflow: visible;
  }
  .timeline-marker {
    position: absolute;
    top: -2px;
    width: 14px;
    height: 36px;
    border-radius: 3px;
    transform: translateX(-50%);
    cursor: default;
    opacity: 0.9;
    border: 2px solid white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
  }
  .timeline-marker.high { background: var(--high); }
  .timeline-marker.medium { background: var(--medium); }
  .timeline-marker.low { background: var(--low); }
  .timeline-marker.none { background: var(--none); }
  .timeline-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.3rem;
  }
  .timeline-legend {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
    font-size: 0.75rem;
  }
  .timeline-legend span {
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }
  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 2px;
    display: inline-block;
  }

  /* Video in card */
  .card-body {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 1.2rem;
    margin-top: 0.8rem;
  }
  .card-video {
    border-radius: 6px;
    overflow: hidden;
    background: #000;
    position: relative;
  }
  .card-video video {
    width: 100%;
    display: block;
    border-radius: 6px;
  }
  .card-video img {
    width: 100%;
    display: block;
    border-radius: 6px;
  }
  .card-analysis {
    min-width: 0;
  }

  footer {
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem 2rem;
    border-top: 1px solid var(--border);
    color: #6c757d;
    font-size: 0.85rem;
  }

  @media (max-width: 768px) {
    .pipeline { flex-direction: column; }
    .pipeline-arrow { transform: rotate(90deg); }
    .ablation-compare { grid-template-columns: 1fr; }
    .card-body { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- Hero Banner -->
<div class="hero">
  <div class="hero-inner">
    <div class="subtitle">Powered by NVIDIA Cosmos Reason 2 (8B)</div>
    <h1>{{ title }}</h1>
    <p class="meta">
      {{ generated_at }}
      {% if video_name %} &middot; {{ video_name }}{% endif %}
      &middot; {{ total_candidates }} clips analyzed
      &middot; Local GPU inference (float16)
    </p>
  </div>
</div>

<!-- Pipeline Diagram -->
<div class="pipeline-section">
  <div class="pipeline">
    <div class="pipeline-step mining">
      <div class="step-label">B1 Mining</div>
      <div class="step-title">Candidate Extraction</div>
      <div class="step-detail">Audio + Optical Flow + YOLO Proximity</div>
    </div>
    <div class="pipeline-arrow">&rarr;</div>
    <div class="pipeline-step mining">
      <div class="step-label">Signal Fusion</div>
      <div class="step-title">Peak Detection</div>
      <div class="step-detail">Weighted fusion &rarr; Top-{{ total_candidates }}</div>
    </div>
    <div class="pipeline-arrow">&rarr;</div>
    <div class="pipeline-step cosmos">
      <div class="step-label">B2 Cosmos Reason 2</div>
      <div class="step-title">Video Understanding</div>
      <div class="step-detail">Severity &middot; Hazards &middot; Causal Reasoning</div>
    </div>
    <div class="pipeline-arrow">&rarr;</div>
    <div class="pipeline-step cosmos">
      <div class="step-label">2-Stage Supplement</div>
      <div class="step-title">Prediction + Action</div>
      <div class="step-detail">Fill missing fields for MED/HIGH</div>
    </div>
    <div class="pipeline-arrow">&rarr;</div>
    <div class="pipeline-step eval">
      <div class="step-label">B3-B5</div>
      <div class="step-title">Rank &middot; Eval &middot; Ablation</div>
      <div class="step-detail">Accuracy &middot; F1 &middot; Checklist</div>
    </div>
  </div>
</div>

<div class="content">

<!-- Detection Timeline -->
{% if timeline %}
<h2>Detection Timeline &mdash; Danger Moments in Source Video</h2>
<div class="timeline-wrap">
  <div style="font-size: 0.85rem; color: #495057; margin-bottom: 0.3rem;">
    Each marker shows where Cosmos Reason 2 detected a risk event in the original recording.
  </div>
  <div class="timeline-bar">
    {% set max_time = timeline[-1].time if timeline[-1].time > 0 else 302 %}
    {% for t in timeline %}
    <div class="timeline-marker {{ t.severity|lower }}"
         style="left: {{ (t.time / max_time * 100)|round(1) }}%"
         title="{{ t.severity }} at {{ t.time|round(0)|int }}s"></div>
    {% endfor %}
  </div>
  <div class="timeline-labels">
    <span>0:00</span>
    <span>{{ (max_time / 4)|round(0)|int }}s</span>
    <span>{{ (max_time / 2)|round(0)|int }}s</span>
    <span>{{ (max_time * 3 / 4)|round(0)|int }}s</span>
    <span>{{ max_time|round(0)|int }}s</span>
  </div>
  <div class="timeline-legend">
    <span><span class="legend-dot" style="background:var(--high)"></span> HIGH</span>
    <span><span class="legend-dot" style="background:var(--medium)"></span> MEDIUM</span>
    <span><span class="legend-dot" style="background:var(--low)"></span> LOW</span>
    <span><span class="legend-dot" style="background:var(--none)"></span> NONE</span>
  </div>
</div>
{% endif %}

<h2>Severity Summary</h2>
<div class="summary-grid">
  {% for sev, count in severity_summary.items() %}
  <div class="summary-card {{ sev|lower }}">
    <div class="count">{{ count }}</div>
    <div class="label">{{ sev }}</div>
  </div>
  {% endfor %}
</div>

<h2>Top {{ examples|length }} Risk Events &mdash; Cosmos Reason 2 Analysis</h2>
{% for ex in examples %}
<div class="card {{ ex.severity|lower }}">
  <div class="card-header">
    <h3 style="margin: 0;">
      #{{ ex.rank }}
      <span class="badge {{ ex.severity|lower }}">{{ ex.severity }}</span>
    </h3>
    <span class="cosmos-tag">Cosmos Reason 2</span>
  </div>

  <div class="detail">
    <span class="detail-label">Clip:</span> {{ ex.clip_name }}
    | <span class="detail-label">Time:</span> {{ "%.1f"|format(ex.peak_time) }}s
    | <span class="detail-label">Mining Score:</span> {{ "%.3f"|format(ex.fused_score) }}
    {% if ex.confidence > 0 %}
    | <span class="detail-label">Model Confidence:</span> {{ "%.0f"|format(ex.confidence * 100) }}%
    {% endif %}
  </div>

  <div class="card-body">
    <!-- Video / Thumbnail -->
    <div class="card-video">
      {% if ex.clip_rel %}
      <video controls preload="metadata"
             {% if ex.thumbnail_b64 %}poster="data:image/jpeg;base64,{{ ex.thumbnail_b64 }}"{% endif %}>
        <source src="{{ ex.clip_rel }}" type="video/mp4">
      </video>
      {% elif ex.thumbnail_b64 %}
      <img src="data:image/jpeg;base64,{{ ex.thumbnail_b64 }}" alt="Frame from {{ ex.clip_name }}">
      {% endif %}
    </div>

    <!-- Analysis -->
    <div class="card-analysis">
      {% if ex.hazards %}
      <div class="detail">
        <span class="detail-label">Hazards:</span>
        <ul class="hazard-list">
          {% for h in ex.hazards %}
          <li>{{ h.type }} &mdash; {{ h.actors }} ({{ h.spatial }})</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <div class="cosmos-output">
        <div class="cosmos-output-label">Cosmos Reason 2 &mdash; Structured Output</div>
        <div class="detail">
          <span class="detail-label">Causal Reasoning:</span> {{ ex.causal_reasoning|truncate(500) }}
        </div>
        {% if ex.prediction %}
        <div class="detail">
          <span class="detail-label">Short-term Prediction:</span> {{ ex.prediction|truncate(300) }}
        </div>
        {% endif %}
        {% if ex.action %}
        <div class="detail">
          <span class="detail-label">Recommended Action:</span> {{ ex.action|truncate(300) }}
        </div>
        {% endif %}
      </div>

      {% if ex.evidence %}
      <div class="detail" style="margin-top: 0.5rem;">
        <span class="detail-label">Evidence:</span>
        <ul class="evidence-list">
          {% for e in ex.evidence %}
          <li>{{ e }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endfor %}

{% if eval %}
<h2>Evaluation Metrics</h2>
<div class="metrics-grid">
  <div class="metric-card">
    <div class="metric-value">{{ "%.1f"|format(eval.accuracy * 100) }}%</div>
    <div class="label">Accuracy</div>
  </div>
  <div class="metric-card">
    <div class="metric-value">{{ "%.3f"|format(eval.macro_f1) }}</div>
    <div class="label">Macro-F1</div>
  </div>
  <div class="metric-card">
    <div class="metric-value">{{ "%.2f"|format(eval.checklist.mean_total) }}/5</div>
    <div class="label">Checklist</div>
  </div>
  <div class="metric-card">
    <div class="metric-value">{{ eval.n_samples }}</div>
    <div class="label">Samples</div>
  </div>
</div>

{% if eval.confusion %}
<h3>Confusion Matrix</h3>
<table>
  <tr>
    <th>GT \ Pred</th>
    {% for label in eval.confusion.keys() %}
    <th>{{ label }}</th>
    {% endfor %}
  </tr>
  {% for gt_label, row in eval.confusion.items() %}
  <tr>
    <td><strong>{{ gt_label }}</strong></td>
    {% for pred_label, count in row.items() %}
    <td>{{ count }}</td>
    {% endfor %}
  </tr>
  {% endfor %}
</table>
{% endif %}
{% endif %}

{% if ablation %}
<h2>Ablation Study &mdash; Why Cosmos Matters</h2>
<p style="color: #6c757d; margin-bottom: 1rem;">
  Comparing a simple mining-score threshold baseline against full Cosmos Reason 2 video inference.
</p>
<div class="ablation-compare">
  {% for ab in ablation %}
  <div class="ablation-card {{ 'cosmos' if 'cosmos' in ab.mode else 'baseline' }}">
    <h4>
      {% if 'cosmos' in ab.mode %}
        Cosmos Reason 2 (Full Pipeline)
      {% else %}
        Baseline (Score Threshold Only)
      {% endif %}
    </h4>
    <div class="ab-metric">
      <span>Accuracy</span>
      <span style="font-weight:700">{{ "%.1f"|format(ab.accuracy * 100) }}%</span>
    </div>
    <div class="ab-metric">
      <span>Macro-F1</span>
      <div class="ab-bar-wrap">
        <div class="ab-bar" style="width: {{ (ab.macro_f1 * 100)|round }}%"></div>
      </div>
      <span style="font-weight:700">{{ "%.3f"|format(ab.macro_f1) }}</span>
    </div>
    <div class="ab-metric">
      <span>Checklist</span>
      <div class="ab-bar-wrap">
        <div class="ab-bar" style="width: {{ (ab.checklist_mean / 5 * 100)|round }}%"></div>
      </div>
      <span style="font-weight:700">{{ "%.1f"|format(ab.checklist_mean) }}/5</span>
    </div>
    {% if 'cosmos' not in ab.mode %}
    <p style="color: #6c757d; font-size: 0.8rem; margin-top: 0.8rem;">
      No causal reasoning, prediction, or action &mdash; just a severity label from mining scores.
    </p>
    {% else %}
    <p style="color: #2e7d32; font-size: 0.8rem; margin-top: 0.8rem;">
      Structured JSON with hazards, causal reasoning, short-term prediction, and recommended action.
    </p>
    {% endif %}
  </div>
  {% endfor %}
</div>
{% endif %}

</div>

<footer>
  AutoRisk-RM v0.1.0 &mdash;
  Video analysis by <strong>NVIDIA Cosmos Reason 2</strong> (nvidia/Cosmos-Reason2-8B, Qwen3VL backbone, float16)
  &middot; Local GPU inference
</footer>

</body>
</html>
