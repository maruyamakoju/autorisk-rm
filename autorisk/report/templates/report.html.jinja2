<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ title }}</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --nvidia: #76b900;
    --nvidia-light: #8ed100;
    --nvidia-dark: #111827;
    --nvidia-darker: #0a0f1a;
    --high: #ef4444;
    --high-bg: #fef2f2;
    --medium: #f59e0b;
    --medium-bg: #fffbeb;
    --low: #eab308;
    --low-bg: #fefce8;
    --none: #22c55e;
    --none-bg: #f0fdf4;
    --bg: #f9fafb;
    --card: #ffffff;
    --text: #111827;
    --text-secondary: #6b7280;
    --text-tertiary: #9ca3af;
    --border: #e5e7eb;
    --border-light: #f3f4f6;
    --radius: 12px;
    --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -1px rgba(0,0,0,0.04);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0,0,0,0.03);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
  }

  /* ---- Hero ---- */
  .hero {
    background: linear-gradient(160deg, var(--nvidia-darker) 0%, #0f172a 40%, #1e293b 100%);
    color: white;
    padding: 3.5rem 2rem 3rem;
    position: relative;
    overflow: hidden;
  }
  .hero::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 500px;
    height: 500px;
    background: radial-gradient(circle, rgba(118,185,0,0.12) 0%, transparent 70%);
    border-radius: 50%;
  }
  .hero-inner {
    max-width: 1100px;
    margin: 0 auto;
    position: relative;
  }
  .hero-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(118,185,0,0.15);
    border: 1px solid rgba(118,185,0,0.3);
    color: var(--nvidia-light);
    padding: 5px 14px;
    border-radius: 20px;
    font-size: 0.78rem;
    font-weight: 600;
    letter-spacing: 0.02em;
    margin-bottom: 1.2rem;
  }
  .hero-badge svg { width: 14px; height: 14px; }
  .hero h1 {
    font-size: 2.2rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    margin-bottom: 0.6rem;
    line-height: 1.2;
  }
  .hero .meta {
    color: #94a3b8;
    font-size: 0.88rem;
    font-weight: 400;
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem 1.2rem;
  }
  .hero .meta span {
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }
  .meta-dot { color: #475569; }

  /* ---- Pipeline ---- */
  .pipeline-section {
    max-width: 1100px;
    margin: -1.5rem auto 0;
    padding: 0 2rem;
    position: relative;
    z-index: 10;
  }
  .pipeline {
    display: flex;
    align-items: stretch;
    gap: 0;
    padding: 0;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
  }
  .pipeline-step {
    flex: 1;
    text-align: center;
    padding: 1.2rem 0.8rem;
    position: relative;
    border-right: 1px solid var(--border-light);
  }
  .pipeline-step:last-child { border-right: none; }
  .pipeline-step::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
  }
  .pipeline-step.mining::after { background: #3b82f6; }
  .pipeline-step.cosmos::after { background: var(--nvidia); }
  .pipeline-step.eval::after { background: #f59e0b; }
  .step-num {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    font-size: 0.7rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }
  .mining .step-num { background: #eff6ff; color: #3b82f6; }
  .cosmos .step-num { background: #f0fdf4; color: #16a34a; }
  .eval .step-num { background: #fffbeb; color: #d97706; }
  .pipeline-step .step-title {
    font-weight: 700;
    font-size: 0.8rem;
    margin-bottom: 0.15rem;
    color: var(--text);
  }
  .pipeline-step .step-detail {
    font-size: 0.7rem;
    color: var(--text-tertiary);
    line-height: 1.4;
  }

  /* ---- Layout ---- */
  .content {
    max-width: 1100px;
    margin: 0 auto;
    padding: 2.5rem 2rem 3rem;
  }
  .section-header {
    margin: 3rem 0 1.2rem;
    padding-bottom: 0.8rem;
    border-bottom: 1px solid var(--border);
  }
  .section-header:first-child { margin-top: 0; }
  .section-header h2 {
    font-size: 1.3rem;
    font-weight: 700;
    letter-spacing: -0.01em;
    color: var(--text);
    margin-bottom: 0.2rem;
  }
  .section-header p {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin: 0;
  }
  h3 {
    font-size: 1rem;
    font-weight: 700;
    margin: 1.5rem 0 0.8rem;
  }

  /* ---- Summary cards ---- */
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.8rem;
    margin-bottom: 0.5rem;
  }
  .summary-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 1.2rem 1rem;
    text-align: center;
    box-shadow: var(--shadow);
    border-top: 3px solid;
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .summary-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
  .summary-card.high { border-color: var(--high); }
  .summary-card.medium { border-color: var(--medium); }
  .summary-card.low { border-color: var(--low); }
  .summary-card.none { border-color: var(--none); }
  .summary-card .count {
    font-size: 2.2rem;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 0.2rem;
  }
  .summary-card.high .count { color: var(--high); }
  .summary-card.medium .count { color: var(--medium); }
  .summary-card.low .count { color: var(--low); }
  .summary-card.none .count { color: var(--none); }
  .summary-card .label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* ---- Timeline ---- */
  .timeline-wrap {
    background: var(--card);
    border-radius: var(--radius);
    padding: 1.5rem;
    margin-bottom: 0.5rem;
    box-shadow: var(--shadow);
  }
  .timeline-bar {
    position: relative;
    height: 28px;
    background: linear-gradient(90deg, #f1f5f9 0%, #e2e8f0 100%);
    border-radius: 6px;
    margin: 0.8rem 0 0.4rem;
  }
  .timeline-marker {
    position: absolute;
    top: 2px;
    width: 12px;
    height: 24px;
    border-radius: 3px;
    transform: translateX(-50%);
    cursor: default;
    border: 2px solid white;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    transition: transform 0.15s;
  }
  .timeline-marker:hover { transform: translateX(-50%) scaleY(1.15); }
  .timeline-marker.high { background: var(--high); }
  .timeline-marker.medium { background: var(--medium); }
  .timeline-marker.low { background: var(--low); }
  .timeline-marker.none { background: var(--none); }
  .timeline-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.72rem;
    color: var(--text-tertiary);
    font-weight: 500;
  }
  .timeline-legend {
    display: flex;
    gap: 1.2rem;
    margin-top: 0.6rem;
    font-size: 0.72rem;
    font-weight: 500;
    color: var(--text-secondary);
  }
  .timeline-legend span { display: flex; align-items: center; gap: 5px; }
  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 3px;
    display: inline-block;
  }

  /* ---- Clip cards ---- */
  .card {
    background: var(--card);
    border-radius: var(--radius);
    margin-bottom: 1.2rem;
    box-shadow: var(--shadow);
    overflow: hidden;
    border: 1px solid var(--border-light);
    transition: box-shadow 0.15s;
  }
  .card:hover { box-shadow: var(--shadow-md); }
  .card-top {
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.8rem;
    border-bottom: 1px solid var(--border-light);
  }
  .card-top.high { background: var(--high-bg); }
  .card-top.medium { background: var(--medium-bg); }
  .card-top.low { background: var(--low-bg); }
  .card-top.none { background: var(--none-bg); }
  .card-rank {
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--text-secondary);
  }
  .badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 6px;
    font-size: 0.72rem;
    font-weight: 700;
    color: white;
    letter-spacing: 0.03em;
  }
  .badge.high { background: var(--high); }
  .badge.medium { background: var(--medium); }
  .badge.low { background: var(--low); color: #1a1a1a; }
  .badge.none { background: var(--none); }
  .cosmos-tag {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: var(--nvidia-dark);
    color: var(--nvidia-light);
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.68rem;
    font-weight: 700;
    letter-spacing: 0.03em;
  }
  .cosmos-tag::before { content: "\25C6"; font-size: 0.55rem; }
  .card-meta {
    padding: 0 1.5rem;
    display: flex;
    gap: 1.5rem;
    font-size: 0.78rem;
    color: var(--text-secondary);
    padding-top: 0.8rem;
  }
  .card-meta strong { color: var(--text); font-weight: 600; }
  .card-body {
    display: grid;
    grid-template-columns: 340px 1fr;
    gap: 1.5rem;
    padding: 1rem 1.5rem 1.5rem;
  }
  .card-video {
    border-radius: 8px;
    overflow: hidden;
    background: #0f172a;
    aspect-ratio: 16/9;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .card-video video, .card-video img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .card-analysis { min-width: 0; }

  .hazard-item {
    display: flex;
    gap: 0.5rem;
    padding: 0.4rem 0;
    font-size: 0.85rem;
    border-bottom: 1px solid var(--border-light);
  }
  .hazard-item:last-child { border-bottom: none; }
  .hazard-type {
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
  }
  .hazard-detail { color: var(--text-secondary); }

  .cosmos-output {
    background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
    border: 1px solid #bbf7d0;
    border-radius: 8px;
    padding: 1rem 1.2rem;
    margin-top: 0.8rem;
  }
  .cosmos-output-label {
    font-size: 0.68rem;
    font-weight: 700;
    color: #15803d;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-bottom: 0.6rem;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .cosmos-output-label::before { content: "\25C6"; font-size: 0.5rem; }
  .cosmos-field {
    margin: 0.5rem 0;
    font-size: 0.85rem;
    line-height: 1.55;
  }
  .cosmos-field-label {
    font-weight: 600;
    color: #166534;
    font-size: 0.78rem;
    display: block;
    margin-bottom: 0.15rem;
  }
  .cosmos-field-value { color: #374151; }

  .evidence-list {
    list-style: none;
    padding: 0;
    margin-top: 0.5rem;
  }
  .evidence-list li {
    font-size: 0.82rem;
    color: var(--text-secondary);
    padding: 0.2rem 0 0.2rem 1rem;
    position: relative;
  }
  .evidence-list li::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0.55rem;
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--text-tertiary);
  }

  /* ---- Metrics ---- */
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.8rem;
    margin: 0.5rem 0 1.5rem;
  }
  .metric-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 1.2rem 1rem;
    text-align: center;
    box-shadow: var(--shadow);
  }
  .metric-value {
    font-size: 1.8rem;
    font-weight: 800;
    color: var(--text);
    line-height: 1;
    margin-bottom: 0.3rem;
  }
  .metric-label {
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* ---- Tables ---- */
  table {
    width: 100%;
    border-collapse: collapse;
    margin: 0.8rem 0;
    background: var(--card);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
    font-size: 0.85rem;
  }
  th, td {
    padding: 0.65rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border-light);
  }
  th {
    background: #f8fafc;
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--text-secondary);
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #fafbfc; }

  /* ---- Ablation ---- */
  .ablation-compare {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin: 0.8rem 0;
  }
  .ablation-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 1.5rem;
    box-shadow: var(--shadow);
    position: relative;
    overflow: hidden;
  }
  .ablation-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
  }
  .ablation-card.baseline::before { background: #cbd5e1; }
  .ablation-card.cosmos::before { background: var(--nvidia); }
  .ablation-card h4 {
    font-size: 0.88rem;
    font-weight: 700;
    margin-bottom: 1.2rem;
  }
  .ab-metric {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border-light);
    font-size: 0.85rem;
  }
  .ab-metric:last-of-type { border-bottom: none; }
  .ab-metric-label { color: var(--text-secondary); }
  .ab-bar-wrap {
    flex: 1;
    max-width: 55%;
    height: 6px;
    background: var(--border-light);
    border-radius: 3px;
    margin: 0 0.8rem;
    overflow: hidden;
  }
  .ab-bar { height: 100%; border-radius: 3px; }
  .baseline .ab-bar { background: #94a3b8; }
  .cosmos .ab-bar { background: var(--nvidia); }
  .ab-metric-val { font-weight: 700; font-size: 0.88rem; min-width: 50px; text-align: right; }
  .ablation-note {
    margin-top: 1rem;
    padding-top: 0.8rem;
    border-top: 1px solid var(--border-light);
    font-size: 0.78rem;
    color: var(--text-tertiary);
    line-height: 1.5;
  }
  .cosmos .ablation-note { color: #15803d; }

  /* ---- Signal heatmap ---- */
  .heatmap-table th, .heatmap-table td {
    text-align: center;
    padding: 0.7rem 0.8rem;
  }
  .heatmap-table td:first-child { text-align: left; font-weight: 600; }
  .heatmap-cell {
    border-radius: 6px;
    padding: 4px 10px;
    display: inline-block;
    min-width: 52px;
    font-weight: 700;
    font-size: 0.82rem;
    text-align: center;
  }
  .corr-bar-wrap {
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
  }
  .corr-bar {
    height: 6px;
    border-radius: 3px;
    background: var(--nvidia);
  }
  .corr-bar.weak { background: #fbbf24; }
  .corr-bar.moderate { background: #f97316; }
  .corr-bar.strong { background: var(--nvidia); }

  /* ---- Per-class ---- */
  .class-metrics-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.8rem;
    margin: 0.8rem 0;
  }
  .class-metric-card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 1.2rem;
    box-shadow: var(--shadow);
    border-top: 3px solid;
  }
  .class-metric-card.high { border-color: var(--high); }
  .class-metric-card.medium { border-color: var(--medium); }
  .class-metric-card.low { border-color: var(--low); }
  .class-metric-card.none { border-color: var(--none); }
  .class-metric-card h4 {
    font-size: 0.88rem;
    font-weight: 700;
    margin-bottom: 0.8rem;
  }
  .class-metric-card h4 span {
    font-weight: 400;
    color: var(--text-tertiary);
    font-size: 0.75rem;
  }
  .class-metric-row {
    display: flex;
    justify-content: space-between;
    padding: 0.35rem 0;
    font-size: 0.82rem;
    color: var(--text-secondary);
  }
  .class-metric-row .val { font-weight: 700; color: var(--text); }

  /* ---- Error analysis ---- */
  .error-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0.8rem;
    margin: 0.8rem 0;
  }
  .error-stat {
    background: var(--card);
    border-radius: var(--radius);
    padding: 1.2rem;
    text-align: center;
    box-shadow: var(--shadow);
  }
  .error-stat .stat-value {
    font-size: 2rem;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 0.2rem;
  }
  .error-stat .stat-label {
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  .error-stat.over .stat-value { color: var(--medium); }
  .error-stat.under .stat-value { color: #8b5cf6; }
  .error-stat.adjacent .stat-value { color: #0ea5e9; }
  .error-stat.major .stat-value { color: var(--high); }
  .error-arrow { font-weight: 700; color: var(--text-tertiary); text-align: center; }

  /* ---- Insight callout ---- */
  .insight-box {
    background: linear-gradient(135deg, #f0fdf4 0%, #fafff5 100%);
    border: 1px solid #bbf7d0;
    border-left: 4px solid var(--nvidia);
    border-radius: 0 var(--radius) var(--radius) 0;
    padding: 1rem 1.4rem;
    margin: 1.2rem 0;
    font-size: 0.85rem;
    line-height: 1.6;
    color: #374151;
  }
  .insight-box strong { color: #15803d; }

  /* ---- Footer ---- */
  footer {
    max-width: 1100px;
    margin: 0 auto;
    padding: 2rem;
    border-top: 1px solid var(--border);
    color: var(--text-tertiary);
    font-size: 0.8rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  footer strong { color: var(--nvidia); font-weight: 700; }

  /* ---- Responsive ---- */
  @media (max-width: 900px) {
    .pipeline { flex-direction: column; }
    .pipeline-step { border-right: none; border-bottom: 1px solid var(--border-light); }
    .pipeline-step:last-child { border-bottom: none; }
    .ablation-compare, .summary-grid, .class-metrics-grid,
    .error-grid, .metrics-grid { grid-template-columns: repeat(2, 1fr); }
    .card-body { grid-template-columns: 1fr; }
    footer { flex-direction: column; gap: 0.5rem; text-align: center; }
  }
  @media (max-width: 520px) {
    .summary-grid, .class-metrics-grid, .error-grid,
    .metrics-grid { grid-template-columns: 1fr; }
    .hero h1 { font-size: 1.5rem; }
  }
</style>
</head>
<body>

<!-- ============ HERO ============ -->
<div class="hero">
  <div class="hero-inner">
    <div class="hero-badge">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
      Powered by NVIDIA Cosmos Reason 2
    </div>
    <h1>{{ title }}</h1>
    <div class="meta">
      {% if video_name %}<span>{{ video_name }}</span>{% endif %}
      <span>{{ total_candidates }} clips analyzed</span>
      <span>Local GPU &middot; float16</span>
      <span>{{ generated_at }}</span>
    </div>
  </div>
</div>

<!-- ============ PIPELINE ============ -->
<div class="pipeline-section">
  <div class="pipeline">
    <div class="pipeline-step mining">
      <div class="step-num">1</div>
      <div class="step-title">Signal Mining</div>
      <div class="step-detail">Audio + Optical Flow + YOLO</div>
    </div>
    <div class="pipeline-step mining">
      <div class="step-num">2</div>
      <div class="step-title">Peak Fusion</div>
      <div class="step-detail">Weighted &rarr; Top-{{ total_candidates }}</div>
    </div>
    <div class="pipeline-step cosmos">
      <div class="step-num">3</div>
      <div class="step-title">Cosmos Reason 2</div>
      <div class="step-detail">Video Understanding</div>
    </div>
    <div class="pipeline-step cosmos">
      <div class="step-num">4</div>
      <div class="step-title">2-Stage Supplement</div>
      <div class="step-detail">Prediction + Action</div>
    </div>
    <div class="pipeline-step eval">
      <div class="step-num">5</div>
      <div class="step-title">Eval &middot; Ablation</div>
      <div class="step-detail">Metrics + Analysis</div>
    </div>
  </div>
</div>

<div class="content">

<!-- ============ TIMELINE ============ -->
{% if timeline %}
<div class="section-header">
  <h2>Detection Timeline</h2>
  <p>Risk events detected by Cosmos Reason 2 across the source recording</p>
</div>
<div class="timeline-wrap">
  <div class="timeline-bar">
    {% set max_time = timeline[-1].time if timeline[-1].time > 0 else 302 %}
    {% for t in timeline %}
    <div class="timeline-marker {{ t.severity|lower }}"
         style="left: {{ (t.time / max_time * 100)|round(1) }}%"
         title="{{ t.severity }} at {{ t.time|round(0)|int }}s"></div>
    {% endfor %}
  </div>
  <div class="timeline-labels">
    <span>0:00</span>
    <span>{{ (max_time / 4)|round(0)|int }}s</span>
    <span>{{ (max_time / 2)|round(0)|int }}s</span>
    <span>{{ (max_time * 3 / 4)|round(0)|int }}s</span>
    <span>{{ max_time|round(0)|int }}s</span>
  </div>
  <div class="timeline-legend">
    <span><span class="legend-dot" style="background:var(--high)"></span> HIGH</span>
    <span><span class="legend-dot" style="background:var(--medium)"></span> MEDIUM</span>
    <span><span class="legend-dot" style="background:var(--low)"></span> LOW</span>
    <span><span class="legend-dot" style="background:var(--none)"></span> NONE</span>
  </div>
</div>
{% endif %}

<!-- ============ SEVERITY SUMMARY ============ -->
<div class="section-header">
  <h2>Severity Distribution</h2>
</div>
<div class="summary-grid">
  {% for sev, count in severity_summary.items() %}
  <div class="summary-card {{ sev|lower }}">
    <div class="count">{{ count }}</div>
    <div class="label">{{ sev }}</div>
  </div>
  {% endfor %}
</div>

<!-- ============ CLIP CARDS ============ -->
<div class="section-header">
  <h2>Top {{ examples|length }} Risk Events</h2>
  <p>Each clip analyzed by Cosmos Reason 2 with structured causal reasoning</p>
</div>

{% for ex in examples %}
<div class="card">
  <div class="card-top {{ ex.severity|lower }}">
    <div>
      <span class="card-rank">#{{ ex.rank }}</span>
      <span class="badge {{ ex.severity|lower }}">{{ ex.severity }}</span>
      {% if ex.confidence > 0 %}
      <span style="font-size:0.75rem;color:var(--text-secondary);margin-left:0.5rem;">{{ "%.0f"|format(ex.confidence * 100) }}% conf.</span>
      {% endif %}
    </div>
    <span class="cosmos-tag">Cosmos Reason 2</span>
  </div>
  <div class="card-meta">
    <span><strong>{{ ex.clip_name }}</strong></span>
    <span>{{ "%.1f"|format(ex.peak_time) }}s</span>
    <span>Score: {{ "%.3f"|format(ex.fused_score) }}</span>
  </div>
  <div class="card-body">
    <div class="card-video">
      {% if ex.clip_rel %}
      <video controls preload="metadata"
             {% if ex.thumbnail_b64 %}poster="data:image/jpeg;base64,{{ ex.thumbnail_b64 }}"{% endif %}>
        <source src="{{ ex.clip_rel }}" type="video/mp4">
      </video>
      {% elif ex.thumbnail_b64 %}
      <img src="data:image/jpeg;base64,{{ ex.thumbnail_b64 }}" alt="Frame from {{ ex.clip_name }}">
      {% else %}
      <div style="color:#475569;font-size:0.8rem;">No preview</div>
      {% endif %}
    </div>
    <div class="card-analysis">
      {% if ex.hazards %}
      <div style="margin-bottom:0.6rem;">
        {% for h in ex.hazards %}
        <div class="hazard-item">
          <span class="hazard-type">{{ h.type }}</span>
          <span class="hazard-detail">{{ h.actors }} &mdash; {{ h.spatial }}</span>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <div class="cosmos-output">
        <div class="cosmos-output-label">Cosmos Reason 2 &mdash; Structured Output</div>
        <div class="cosmos-field">
          <span class="cosmos-field-label">Causal Reasoning</span>
          <span class="cosmos-field-value">{{ ex.causal_reasoning|truncate(500) }}</span>
        </div>
        {% if ex.prediction %}
        <div class="cosmos-field">
          <span class="cosmos-field-label">Short-term Prediction</span>
          <span class="cosmos-field-value">{{ ex.prediction|truncate(300) }}</span>
        </div>
        {% endif %}
        {% if ex.action %}
        <div class="cosmos-field">
          <span class="cosmos-field-label">Recommended Action</span>
          <span class="cosmos-field-value">{{ ex.action|truncate(300) }}</span>
        </div>
        {% endif %}
      </div>

      {% if ex.evidence %}
      <ul class="evidence-list">
        {% for e in ex.evidence %}
        <li>{{ e }}</li>
        {% endfor %}
      </ul>
      {% endif %}
    </div>
  </div>
</div>
{% endfor %}

<!-- ============ EVALUATION ============ -->
{% if eval %}
<div class="section-header">
  <h2>Evaluation Metrics</h2>
  <p>Classification performance against blind-labeled ground truth</p>
</div>
<div class="metrics-grid">
  <div class="metric-card">
    <div class="metric-value">{{ "%.1f"|format(eval.accuracy * 100) }}%</div>
    <div class="metric-label">Accuracy</div>
  </div>
  <div class="metric-card">
    <div class="metric-value">{{ "%.3f"|format(eval.macro_f1) }}</div>
    <div class="metric-label">Macro-F1</div>
  </div>
  <div class="metric-card">
    <div class="metric-value">{{ "%.1f"|format(eval.checklist.mean_total) }}/5</div>
    <div class="metric-label">Checklist</div>
  </div>
  <div class="metric-card">
    <div class="metric-value">{{ eval.n_samples }}</div>
    <div class="metric-label">Samples</div>
  </div>
</div>

{% if eval.confusion %}
<h3>Confusion Matrix</h3>
<table>
  <tr>
    <th>GT \ Pred</th>
    {% for label in eval.confusion.keys() %}
    <th>{{ label }}</th>
    {% endfor %}
  </tr>
  {% for gt_label, row in eval.confusion.items() %}
  <tr>
    <td><strong>{{ gt_label }}</strong></td>
    {% for pred_label, count in row.items() %}
    <td style="{% if gt_label == pred_label and count > 0 %}font-weight:700;color:var(--nvidia);{% endif %}">{{ count }}</td>
    {% endfor %}
  </tr>
  {% endfor %}
</table>
{% endif %}
{% endif %}

<!-- ============ ABLATION ============ -->
{% if ablation %}
<div class="section-header">
  <h2>Ablation Study &mdash; Why Cosmos Matters</h2>
  <p>Mining-score threshold baseline vs. full Cosmos Reason 2 video inference</p>
</div>
<div class="ablation-compare">
  {% for ab in ablation %}
  <div class="ablation-card {{ 'cosmos' if 'cosmos' in ab.mode else 'baseline' }}">
    <h4>
      {% if 'cosmos' in ab.mode %}Cosmos Reason 2 (Full Pipeline)
      {% else %}Baseline (Score Threshold){% endif %}
    </h4>
    <div class="ab-metric">
      <span class="ab-metric-label">Accuracy</span>
      <div class="ab-bar-wrap"><div class="ab-bar" style="width:{{ (ab.accuracy * 100)|round }}%"></div></div>
      <span class="ab-metric-val">{{ "%.1f"|format(ab.accuracy * 100) }}%</span>
    </div>
    <div class="ab-metric">
      <span class="ab-metric-label">Macro-F1</span>
      <div class="ab-bar-wrap"><div class="ab-bar" style="width:{{ (ab.macro_f1 * 100)|round }}%"></div></div>
      <span class="ab-metric-val">{{ "%.3f"|format(ab.macro_f1) }}</span>
    </div>
    <div class="ab-metric">
      <span class="ab-metric-label">Checklist</span>
      <div class="ab-bar-wrap"><div class="ab-bar" style="width:{{ (ab.checklist_mean / 5 * 100)|round }}%"></div></div>
      <span class="ab-metric-val">{{ "%.1f"|format(ab.checklist_mean) }}/5</span>
    </div>
    <div class="ablation-note">
      {% if 'cosmos' not in ab.mode %}No causal reasoning, prediction, or action &mdash; just a severity label from mining scores.
      {% else %}Structured JSON with hazards, causal reasoning, short-term prediction, and recommended action.{% endif %}
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- ============ DEEP ANALYSIS ============ -->
{% if analysis %}

<div class="section-header">
  <h2>Signal Contribution Analysis</h2>
  <p>Spearman rank correlation between each mining signal and ground-truth severity</p>
</div>

<table class="heatmap-table">
  <tr>
    <th style="text-align:left">Signal</th>
    <th>Spearman &rho;</th>
    <th>p-value</th>
    <th>Threshold Acc.</th>
    <th>Threshold F1</th>
  </tr>
  {% for s in analysis.signal_analysis %}
  <tr>
    <td>{{ s.signal_name | capitalize }}</td>
    <td>
      <div class="corr-bar-wrap">
        <div class="corr-bar {% if s.spearman_rho|abs < 0.15 %}weak{% elif s.spearman_rho|abs < 0.3 %}moderate{% else %}strong{% endif %}"
             style="width: {{ (s.spearman_rho|abs * 180)|round|int }}px"></div>
        <span style="font-weight:700">{{ "%.3f"|format(s.spearman_rho) }}</span>
      </div>
    </td>
    <td style="color:{% if s.spearman_p < 0.05 %}var(--nvidia){% else %}var(--text-tertiary){% endif %}">{{ "%.4f"|format(s.spearman_p) }}</td>
    <td style="font-weight:600">{{ "%.1f"|format(s.threshold_accuracy * 100) }}%</td>
    <td style="font-weight:600">{{ "%.3f"|format(s.threshold_f1) }}</td>
  </tr>
  {% endfor %}
</table>

{% if analysis.signal_heatmap %}
<h3>Signal &times; Severity Heatmap</h3>
<table class="heatmap-table">
  <tr>
    <th style="text-align:left">Signal</th>
    <th>NONE</th><th>LOW</th><th>MEDIUM</th><th>HIGH</th>
  </tr>
  {% for sig, sevs in analysis.signal_heatmap.items() %}
  <tr>
    <td>{{ sig | capitalize }}</td>
    {% for sev_name in ["NONE", "LOW", "MEDIUM", "HIGH"] %}
    {% set val = sevs.get(sev_name, 0) %}
    <td>
      <span class="heatmap-cell"
            style="background: rgba(118,185,0,{{ (val * 0.7 + 0.1)|round(2) }});
                   color: {% if val > 0.45 %}white{% else %}#1a1a1a{% endif %};">
        {{ "%.2f"|format(val) }}
      </span>
    </td>
    {% endfor %}
  </tr>
  {% endfor %}
</table>

<div class="insight-box">
  <strong>Finding:</strong>
  Fused signal achieves the best threshold-based F1
  ({{ "%.3f"|format(analysis.signal_analysis[-1].threshold_f1) }}),
  confirming that multi-signal fusion outperforms any individual signal.
  {% set best_single = analysis.signal_analysis[:-1]|sort(attribute='spearman_rho', reverse=true)|first %}
  {{ best_single.signal_name | capitalize }} shows the highest individual correlation
  (&rho;={{ "%.3f"|format(best_single.spearman_rho) }}).
  No single signal is statistically significant (all p&gt;0.05),
  reinforcing the need for Cosmos video understanding beyond simple signal thresholds.
</div>
{% endif %}

<div class="section-header">
  <h2>Per-Class Performance</h2>
  <p>Precision, recall, and F1 broken down by severity class</p>
</div>

<div class="class-metrics-grid">
  {% for m in analysis.per_class_metrics %}
  <div class="class-metric-card {{ m.label|lower }}">
    <h4>{{ m.label }} <span>(n={{ m.support }})</span></h4>
    <div class="class-metric-row"><span>Precision</span><span class="val">{{ "%.1f"|format(m.precision * 100) }}%</span></div>
    <div class="class-metric-row"><span>Recall</span><span class="val">{{ "%.1f"|format(m.recall * 100) }}%</span></div>
    <div class="class-metric-row"><span>F1</span><span class="val">{{ "%.3f"|format(m.f1) }}</span></div>
  </div>
  {% endfor %}
</div>

<div class="insight-box">
  <strong>Finding:</strong>
  {% set best_class = analysis.per_class_metrics|sort(attribute='f1', reverse=true)|first %}
  {% set worst_class = analysis.per_class_metrics|sort(attribute='f1')|first %}
  Cosmos performs best on <strong>{{ best_class.label }}</strong> (F1={{ "%.3f"|format(best_class.f1) }})
  and struggles most with <strong>{{ worst_class.label }}</strong> (F1={{ "%.3f"|format(worst_class.f1) }}).
  {% if worst_class.label == "NONE" %}
  The model tends to find potential risks even in safe scenes &mdash; a conservative bias
  that is safer in real-world driving than missing actual hazards.
  {% endif %}
</div>

<div class="section-header">
  <h2>Error Analysis</h2>
  <p>Systematic classification of {{ analysis.error_summary.total_errors }} misclassifications out of {{ analysis.per_class_metrics|sum(attribute='support') }} clips</p>
</div>

<div class="error-grid">
  <div class="error-stat over">
    <div class="stat-value">{{ analysis.error_summary.over_estimation }}</div>
    <div class="stat-label">Over-estimation</div>
  </div>
  <div class="error-stat under">
    <div class="stat-value">{{ analysis.error_summary.under_estimation }}</div>
    <div class="stat-label">Under-estimation</div>
  </div>
  <div class="error-stat adjacent">
    <div class="stat-value">{{ analysis.error_summary.adjacent_miss }}</div>
    <div class="stat-label">Adjacent (off by 1)</div>
  </div>
  <div class="error-stat major">
    <div class="stat-value">{{ analysis.error_summary.major_miss }}</div>
    <div class="stat-label">Major (off by 2+)</div>
  </div>
</div>

<table>
  <tr>
    <th>Clip</th><th>GT</th><th></th><th>Predicted</th><th>Type</th><th>Gap</th><th>Score</th>
  </tr>
  {% for e in analysis.error_details %}
  <tr>
    <td style="font-size:0.8rem;">{{ e.clip_name }}</td>
    <td><span class="badge {{ e.gt_severity|lower }}">{{ e.gt_severity }}</span></td>
    <td class="error-arrow">&rarr;</td>
    <td><span class="badge {{ e.pred_severity|lower }}">{{ e.pred_severity }}</span></td>
    <td style="font-size:0.8rem;">{{ e.error_type | replace("_", "-") }}</td>
    <td style="text-align:center;font-weight:600;">&plusmn;{{ e.severity_gap }}</td>
    <td style="font-weight:600;">{{ "%.3f"|format(e.fused_score) }}</td>
  </tr>
  {% endfor %}
</table>

<div class="insight-box">
  <strong>Finding:</strong>
  {{ "%.0f"|format(analysis.error_summary.over_estimation_pct) }}% of errors are over-estimations
  (model predicts higher severity than GT).
  {{ "%.0f"|format(analysis.error_summary.adjacent_miss_pct) }}% are adjacent misses
  (off by one level), suggesting the model's understanding is close but boundary calibration
  between severity classes remains the primary challenge.
  {% if analysis.error_summary.mean_mining_score_over > 0 and analysis.error_summary.mean_mining_score_under > 0 %}
  Mean mining score for over-estimated clips
  ({{ "%.3f"|format(analysis.error_summary.mean_mining_score_over) }})
  is {{ "lower" if analysis.error_summary.mean_mining_score_over < analysis.error_summary.mean_mining_score_under else "higher" }}
  than for under-estimated clips
  ({{ "%.3f"|format(analysis.error_summary.mean_mining_score_under) }}).
  {% endif %}
</div>

{% endif %}

</div>

<footer>
  <span>AutoRisk-RM v0.1.0</span>
  <span>Video analysis by <strong>NVIDIA Cosmos Reason 2</strong> (8B, float16) &middot; Local GPU inference</span>
</footer>

</body>
</html>
