# Audit Contract (Machine-Validated)

This document defines the audit contract enforced by:

- `python -m autorisk.cli audit-verify`
- `python -m autorisk.cli audit-validate --enforce`
- `python -m autorisk.cli finalize-run --audit-grade`

## Required Pack Files

- `manifest.json`
- `decision_trace.jsonl`
- `checksums.sha256.txt`

## Optional Pack Files (Validated If Present)

- `signature.json`
- `attestation.json`
- `run_artifacts/policy_report.json`
- `run_artifacts/review_queue.json`
- `run_artifacts/policy_snapshot.json`
- `run_artifacts/review_apply_report.json`
- `run_artifacts/review_diff_report.json`
- `run_artifacts/audit_validate_report.json`
- `run_artifacts/finalize_record.json`
- `human_review/*.jsonl`

## Integrity and Authenticity

- `audit-verify` validates checksums for all checksummed files.
- `audit-sign` signs `checksums.sha256.txt` and `manifest.json` digests.
- `attestation.json` (generated by `finalize-run`) signs non-checksummed run-artifact digests:
  - `SHA256(run_artifacts/finalize_record.json)`
  - `SHA256(run_artifacts/audit_validate_report.json)`
  - plus `pack_fingerprint = SHA256(checksums.sha256.txt)`
- `audit-verify --public-key/--public-key-dir --require-signature --require-public-key` enforces trusted-key authenticity.
- For PACK-only verification, add `--require-attestation` to enforce attestation authenticity.
- `audit-handoff-verify --require-attestation` enforces attestation authenticity and hash binding.
- `--no-require-attestation` is for diagnostics only and must not be used for audit-grade acceptance.
- In audit-grade verification profile, attestation key identity must match signature key identity.

## Unchecked Files

- `run_artifacts/finalize_record.json` is intentionally not listed in `checksums.sha256.txt`.
- `run_artifacts/audit_validate_report.json` is intentionally not listed in `checksums.sha256.txt`.
- Rationale: avoid checksum/fingerprint circular dependency in finalize metadata updates.
- Both files are still contract-checked by `audit-validate` semantic rules (fingerprint, signature key consistency, audit-grade flags, validate report consistency).
- `handoff_checksums.sha256.txt` excludes `finalize_record.json` and `PACK.zip` to avoid circular handoff metadata.
- Handoff trust is anchored to `PACK.zip` verification (`audit-verify --require-attestation`), then to `PACK.zip!run_artifacts/finalize_record.json` anchor fields:
  - `handoff_anchor_checksums_sha256`
  - `handoff_anchor_verifier_bundle_zip_sha256`

## Semantic Rules (Examples)

- `candidate_rank` must be positive, non-duplicated, and gap-free.
- `severity` must be one of `NONE/LOW/MEDIUM/HIGH`.
- `manifest.summary.records` must match `decision_trace.jsonl` row count.
- `review.record_sha256` in reviewed results must exist in bundled review log.
- `finalize_record.pack_fingerprint` must match `SHA256(checksums.sha256.txt)`.
- `PACK`-internal `run_artifacts/finalize_record.json` must keep `handoff_*` empty and use `handoff_anchor_*` (if present) to avoid circular dependencies.
- In audit-grade mode, finalize flags must satisfy:
  - `require_signature=true`
  - `require_trusted_key=true`
  - `trust_embedded_public_key=false`

## Audit-Grade One Command

```bash
python -m autorisk.cli finalize-run -r RUN_DIR --zip --audit-grade \
  --sign-private-key keys/private.pem --sign-public-key-dir keys/trusted \
  --handoff-out RUN_DIR/handoff_latest
```

This command performs review apply, policy gate, pack, sign, verify, validate, and handoff generation.
